<!DOCTYPE html>
<html lang="en">
  <head>   
    <title>Welcome to dConnect</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.3/css/uikit.min.css" />
    <script src="//ajaxorg.github.io/ace-builds/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.3/js/uikit.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.3/js/uikit-icons.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/eosjs@15.0.3/lib/eos.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.scattercdn.com/file/scatter-cdn/js/latest/scatterjs-core.min.js"></script>
    <script src="https://cdn.scattercdn.com/file/scatter-cdn/js/latest/scatterjs-plugin-eosjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/seedrandom/3.0.1/seedrandom.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/nedb/1.8.0/nedb.min.js"></script>

    <script type="text/javascript" src="eos.js"></script>
    <link rel="shortcut icon" type="image/png" href="favicon-96x96.png"/>
</head>
  <body>
      <div uk-sticky="sel-target: .uk-navbar-container; cls-active: uk-navbar-sticky; bottom: #transparent-sticky-navbar">
        <nav class="uk-navbar-container" uk-navbar style="position: relative; z-index: 980;">
          <div class="uk-navbar-left">

            <ul class="uk-navbar-nav">
              <li>
                <form>
                <input id="name" name="q"/>
                  <a href="#" id="save">SAVE</a>
                  <a href="#" id="test" style="position:absolute; right:25px; top:0px;">TEST</a>
                </form>
              </li>
            </ul>
          </div>
        </nav>
      </div>
      <style>
      #editor {
          position: absolute;
          top:25px;
          bottom: 0px;
          left:0px;
          right:300px;
          /*width:100%;*/
          height:100%;
      }
      #rpc {
          position: absolute;
          top:25px;
          bottom: 0px;
          right:0px;
          width:300px;
          height:100%;
      }
      </style>
      <div id="editor">done();//your action must end with this</div>
      <div id="rpc">{"key":"val"}</div>
      <script>
          var rpc = ace.edit("rpc");
          rpc.getSession().setUseWorker(false);
          rpc.setTheme("ace/theme/monokai");
          rpc.getSession().setMode("ace/mode/javascript");
          var editor = ace.edit("editor");
          editor.getSession().setUseWorker(false);
          editor.setTheme("ace/theme/monokai");
          editor.getSession().setMode("ace/mode/javascript");
          const rng = Math.seedrandom();

        document.getElementById('test').onclick = async()=>{
            const vmdb = await getJSON('/db/'+account.name);
            const collection = new Nedb();
            collection.insert(vmdb);
            const vmState = { 
              api: {
                sender:"sender",
                id:"id",
                action:document.getElementById('name').value,
                collection,
                fromCollection:async (contract)=>{return (await dbo.collection(contract)).find},
                payload: JSON.parse(rpc.getValue()),
                random: () => rng(),
                debug: log => console.log(log), 
                emit: (event, data) => typeof event === 'string' && results.logs.events.push({ contract, event, data }),
                assert: (condition, error) => {
                  if (!condition && typeof error === 'string') {
                    results.logs.errors.push(error);
                  }
                  return condition;
                },
              },
              done : (error)=>{console.log(error)}
              
            };
            function evalInContext() {
                const results = {logs:{errors:[],events:[]}}
                eval('const done=this.done;const api=this.api;'+editor.getValue());
                console.log(results);
            }
          
            evalInContext.call(vmState);
        };
        
        var getJSON = function(url) {
          return new Promise((resolve, reject)=>{
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.responseType = 'json';
            xhr.onload = function() {
              var status = xhr.status;
              if (status === 200) {
                
                resolve(xhr.response);
              } else {
                reject(xhr.response);
              }
            };
            xhr.send();
          });
          
        };
        const getContracts = async()=>{
          window.contracts = {};
          const contracts = await getJSON('/db/contract');
          console.log(contracts);
          for(index in contracts) {
            const contract = contracts[index];
            if(!window.contracts[contract.contract]) window.contracts[contract.contract] = {};
            window.contracts[contract.contract][contract.action] = contract;
          }
        }
        getContracts();

        document.getElementById('save').onclick = ()=>{
          
          ScatterJS.scatter.connect('dconnectlive').then(connected => {
            if(!connected) return false;
            window.scatter = ScatterJS.scatter;
            const requiredFields = { accounts:[network] };
            scatter.getIdentity(requiredFields).then(() => {
                window.account = scatter.identity.accounts.find(x => x.blockchain === 'eos');
                const eosOptions = { expireInSeconds:60 };
                window.eos = scatter.eos(network, Eos, eosOptions);
                eos.transaction({
                   actions: [{
                     account: 'dconnectlive',
                     name: 'set',
                     authorization: [{
                       actor: account.name,
                       permission: 'active',
                     }],
                     data: {
                       app: 'system',
                       account: account.name,
                       key: 'setcontract',
                       value:JSON.stringify({'action':document.getElementById('name').value,'code':editor.getValue()})
                     },
                   }]
                 }, {
                   blocksBehind: 9,
                   expireSeconds: 180
                 });
                const transactionOptions = { authorization:[`${account.name}@${account.authority}`] };
            }).catch(error => {
                console.error(error);
            });
            return false;
        });

          
        }
      </script>
  </body>
</html>


