<!DOCTYPE html>
<html lang="en">
  <head>   
    <title>Welcome to dConnect ðŸŽŠ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.3/css/uikit.min.css" />
    <script src="//ajaxorg.github.io/ace-builds/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.3/js/uikit.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.3/js/uikit-icons.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/eosjs@15.0.3/lib/eos.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.scattercdn.com/file/scatter-cdn/js/latest/scatterjs-core.min.js"></script>
    <script src="https://cdn.scattercdn.com/file/scatter-cdn/js/latest/scatterjs-plugin-eosjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/seedrandom/3.0.1/seedrandom.min.js"></script>
    <script src="./bundle.js" type="text/javascript"></script>
    <script type="text/javascript" src="eos.js"></script>
    <link rel="shortcut icon" type="image/png" href="favicon-96x96.png"/>
  </head>
  <body>
    <div uk-sticky="sel-target: .uk-navbar-container; cls-active: uk-navbar-sticky; bottom: #transparent-sticky-navbar">
      <nav class="uk-navbar-container" uk-navbar style="position: relative; z-index: 980;">
        <div class="uk-navbar-left">
          <ul class="uk-navbar-nav">
            <li>
            <button type="button">LOAD</button>
            <li uk-dropdown="mode: click">
              <ul id="contracts" class="uk-nav uk-dropdown-nav">
              </ul>
            </li>
            </li>
            <li>
              <form>
                <input id="name" name="q"/>
                <a href="#" id="save">SAVE</a>
                <a href="#" id="test" style="position:absolute; right:25px; top:0px;">TEST</a>
                <span style="position:absolute; right:70px; top:0px;" id="status"></span>
              </form>
            </li>
          </ul>
        </div>
      </nav>
    </div>
    <style>
      #editor {
        position: absolute;
        top:25px;
        bottom: 0px;
        left:0px;
        right:300px;
        /*width:100%;*/
        height:100%;
      }
      #rpc {
        position: absolute;
        top:25px;
        bottom: 0px;
        right:0px;
        width:300px;
        height:100%;
      }
    </style>
    <div id="editor">done();//your action must end with this</div>
    <div id="rpc">{"key":"val"}</div>
    <script>
      var getJSON = function(url) {
        return new Promise((resolve, reject)=>{
          var xhr = new XMLHttpRequest();
          xhr.open('GET', url, true);
          xhr.responseType = 'json';
          xhr.onload = function() {
            var status = xhr.status;
            if (status === 200) {
              resolve(xhr.response);
            } else {
              reject(xhr.response);
            }
          };
          xhr.send();
        });
      };
      var rpc = ace.edit("rpc");
      rpc.getSession().setUseWorker(false);
      rpc.setTheme("ace/theme/monokai");
      rpc.getSession().setMode("ace/mode/javascript");
      var editor = ace.edit("editor");
      editor.getSession().setUseWorker(false);
      editor.setTheme("ace/theme/monokai");
      editor.getSession().setMode("ace/mode/javascript");
      const rng = Math.seedrandom();
      doState = async ()=>{
        const [stats] = await getJSON('https://messaround.glitch.me/db/state');
        const now = new Date();
        var offset = (new Date((new Date()).toUTCString())).getTime() - new Date(stats.blockInfo.timestamp).getTime();
          document.getElementById('status').innerHTML = "&nbsp"+Number(offset/1000/60/60).toFixed(4)+" Hours behind";
        }
      doState();setInterval(doState,10000);
      document.getElementById('test').onclick = async()=>{
        console.log('test');
        const vmdb = await getJSON('/db/'+account.name);
        db.addCollection("test");
        for(index in vmdb) {
          db.test.upsert(vmdb[index]);
        }
        const vmState = { 
          api: {
            sender:"sender",
            id:"id",
            action:document.getElementById('name').value,
            collection:{update:console.log, findOne:(query)=>{return new Promise((resolve,reject)=>{db.test.findOne(query,(err,res)=>{if(err){reject(err);}else {resolve(res);}})})}, find:db.test.find },
            fromCollection:async (contract)=>{return (await dbo.collection(contract)).find},
            payload: JSON.parse(rpc.getValue()),
            random: () => rng(),
            debug: log => console.log(log), 
            emit: (event, data) => typeof event === 'string' && results.logs.events.push({ contract, event, data }),
            assert: (condition, error) => {
              if (!condition && typeof error === 'string') {
                results.logs.errors.push(error);
              }
              return condition;
            },
          },
          done : (error)=>{console.log(error)}
        };
        function evalInContext() {
          const results = {logs:{errors:[],events:[]}}
          eval('const done=this.done;const api=this.api;'+editor.getValue());
          console.log(results);
        }
        evalInContext.call(vmState);
      };
      const getContracts = async()=>{
        window.contracts = {};
        const contracts = await getJSON('/db/contract');
        let html = '';
        for(index in contracts) {
          const contract = contracts[index];
          if(!window.contracts[contract.contract]) window.contracts[contract.contract] = {};
          window.contracts[contract.contract][contract.action] = contract;
          html += `<li class="uk-nav-divider"></li><li onclick="editor.setValue(contracts['${contract.contract}']['${contract.action}'].code)"><a href="#" >${contract.contract+"|"+contract.action}</a></li>`
        }
        document.getElementById('contracts').innerHTML = html;
      }
      getContracts();
      document.getElementById('save').onclick = ()=>{
        ScatterJS.scatter.connect('dconnect').then(connected => {
          if(!connected) return false;
          window.scatter = ScatterJS.scatter;
          const requiredFields = { accounts:[network] };
          scatter.getIdentity(requiredFields).then(() => {
            window.account = scatter.identity.accounts.find(x => x.blockchain === 'eos');
            const eosOptions = { expireInSeconds:60 };
            window.eos = scatter.eos(network, Eos, eosOptions);
            eos.transaction({
              actions: [{
                account: 'dconnectlive',
                name: 'set',
                authorization: [{
                  actor: account.name,
                  permission: 'active',
                }],
                data: {
                  app: 'system',
                  account: account.name,
                  key: 'setcontract',
                  value:JSON.stringify({'action':document.getElementById('name').value,'code':editor.getValue()})
                },
              }]
            }, {
              blocksBehind: 9,
              expireSeconds: 180
            });
            const transactionOptions = { authorization:[`${account.name}@${account.authority}`] };
          }).catch(error => {
            console.error(error);
          });
          return false;
        });
      }
    </script>
  </body>
</html>
