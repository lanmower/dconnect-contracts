<!DOCTYPE html>
<html lang="en">
  <head>   
    <title>Welcome to dConnect</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.3/css/uikit.min.css" />
    <script src="//ajaxorg.github.io/ace-builds/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.3/js/uikit.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.3/js/uikit-icons.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/eosjs@15.0.3/lib/eos.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.scattercdn.com/file/scatter-cdn/js/latest/scatterjs-core.min.js"></script>
    <script src="https://cdn.scattercdn.com/file/scatter-cdn/js/latest/scatterjs-plugin-eosjs.min.js"></script>
    <!--script type="text/javascript" src="eos.js"></script-->
    <link rel="shortcut icon" type="image/png" href="favicon-96x96.png"/>
</head>
  <body>
      <div uk-sticky="sel-target: .uk-navbar-container; cls-active: uk-navbar-sticky; bottom: #transparent-sticky-navbar">
        <nav class="uk-navbar-container" uk-navbar style="position: relative; z-index: 980;">
          <div class="uk-navbar-left">

            <ul class="uk-navbar-nav">
              <li>
                <form>
                <input name="q"/>
                  <a href="#" id="save">SAVE</a>
                  <a href="#" id="test" style="position:absolute; right:25px; top:0px;">TEST</a>
                </form>
              </li>
            </ul>
          </div>
        </nav>
      </div>
      <style>
      #editor {
          position: absolute;
          top:25px;
          bottom: 0px;
          left:0px;
          right:300px;
          /*width:100%;*/
          height:100%;
      }
      #rpc {
          position: absolute;
          top:25px;
          bottom: 0px;
          right:0px;
          width:300px;
          height:100%;
      }
      </style>
      <div id="editor">done();//your action must end with this</div>
      <div id="rpc">{"key":"val"}</div>
      <script>
          var rpc = ace.edit("rpc");
          rpc.getSession().setUseWorker(false);
          rpc.setTheme("ace/theme/monokai");
          rpc.getSession().setMode("ace/mode/javascript");
          var editor = ace.edit("editor");
          editor.getSession().setUseWorker(false);
          editor.setTheme("ace/theme/monokai");
          editor.getSession().setMode("ace/mode/javascript");
             const vmState = { 
        api: { 
          sender,
          id,
          action,
          collection,
          fromCollection:async (contract)=>{return (await dbo.collection(contract)).find},
          payload: payload,
          random: () => rng(),
          debug: log => console.log(log), 
          emit: (event, data) => typeof event === 'string' && results.logs.events.push({ contract, event, data }),
          assert: (condition, error) => {
            if (!condition && typeof error === 'string') {
              results.logs.errors.push(error);
            }
            return condition;
          },
        },
      };
        document.getElementById('test').onclick = ()=>{
            function evalInContext() {
                console.log(this); 
                eval(rpc.getValue());
            }
          
            evalInContext.call(
              {
                api:{
                }
              });
        });
        
        document.getElementById('save').onclick = ()=>{
          ScatterJS.scatter.connect('dconnectlive').then(connected => {
            if(!connected) return false;
            window.scatter = ScatterJS.scatter;
            const requiredFields = { accounts:[network] };
            scatter.getIdentity(requiredFields).then(() => {
                const account = scatter.identity.accounts.find(x => x.blockchain === 'eos');
                const eosOptions = { expireInSeconds:60 };
                const eos = scatter.eos(network, Eos, eosOptions);
                eos.transaction({
                   actions: [{
                     account: 'dconnectlive',
                     name: 'set',
                     authorization: [{
                       actor: account.name,
                       permission: 'active',
                     }],
                     data: {
                       app: 'system',
                       account: account.name,
                       key: 'setcontract',
                       value:JSON.stringify({'action':'test','code':editor.getValue()})
                     },
                   }]
                 }, {
                   blocksBehind: 9,
                   expireSeconds: 180
                 });
                const transactionOptions = { authorization:[`${account.name}@${account.authority}`] };
            }).catch(error => {
                console.error(error);
            });
            return false;
        });

          
        }
      </script>
  </body>
</html>


